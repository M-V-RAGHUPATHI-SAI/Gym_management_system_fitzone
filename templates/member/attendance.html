{% extends "base.html" %}

{% block title %}My Attendance - Member{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">
        <i class="fas fa-calendar-check mr-3 text-primary"></i>My Attendance
    </h1>
    <p class="text-gray-600">Track your gym visits and training sessions</p>
</div>

<!-- Attendance Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <div class="stat-value text-primary">{{ total_sessions }}</div>
                <div class="stat-label">Total Sessions</div>
            </div>
            <i class="fas fa-calendar text-primary text-2xl"></i>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <div class="stat-value text-success">{{ present_sessions }}</div>
                <div class="stat-label">Sessions Attended</div>
            </div>
            <i class="fas fa-check-circle text-success text-2xl"></i>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="flex items-center justify-between">
            <div>
                <div class="stat-value text-secondary">{{ "%.1f"|format(attendance_percentage) }}%</div>
                <div class="stat-label">Attendance Rate</div>
            </div>
            <i class="fas fa-percentage text-secondary text-2xl"></i>
        </div>
    </div>
</div>

<!-- Attendance Records -->
<div class="card">
    <div class="card-header flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-900">Attendance History</h2>
        <a href="{{ url_for('member.schedule_session') }}" class="btn btn-primary">
            <i class="fas fa-calendar-plus mr-2"></i>Book Session
        </a>
    </div>
    <div class="card-body p-0">
        {% if attendance_records %}
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time Slot</th>
                        <th>Trainer</th>
                        <th>Status</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_records %}
                    <tr>
                        <td>
                            <div class="font-medium">{{ record.date|datetimeformat('%B %d, %Y') }}</div>
                            <div class="text-sm text-gray-500">{{ record.date|datetimeformat('%A') }}</div>
                        </td>

                        <td>
                            {% if record.time_slot %}
                                <span class="text-sm font-medium">{{ record.time_slot }}</span>
                            {% elif record.check_in_time and record.check_out_time %}
                                <span class="text-sm">
                                    {{ record.check_in_time.strftime('%I:%M %p') if record.check_in_time else '' }} - 
                                    {{ record.check_out_time.strftime('%I:%M %p') if record.check_out_time else '' }}
                                </span>
                            {% elif record.check_in_time %}
                                <span class="text-sm">
                                    {{ record.check_in_time.strftime('%I:%M %p') }}
                                </span>
                            {% else %}
                                <span class="text-gray-400">Time Not Set</span>
                            {% endif %}
                        </td>

                        <td>
                            <span class="text-sm">{{ record.trainer_name or 'N/A' }}</span>
                        </td>

                        <td>
                            <span class="badge badge-{{ 'success' if record.status == 'present' else 'warning' if record.status == 'scheduled' else 'danger' }}">
                                {{ record.status|title }}
                            </span>
                        </td>

                        <td>
                            {% if record.notes %}
                                <span class="text-sm text-gray-600">{{ record.notes }}</span>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>

                        <td>
                            {# Show reschedule form only for upcoming scheduled sessions #}
                            {% if record.status == 'scheduled' and record.date and record.date >= today %}
                                <form action="{{ url_for('member.reschedule_attendance', attendance_id=record.id) }}" method="post" class="inline-flex items-center space-x-2">
                                    {# If you use Flask-WTF or CSRF, include token here: {{ csrf_token() }} #}
                                    <select name="time_slot" required class="form-select text-sm">
                                        <option value="">Choose new slot</option>

                                        {% if time_slots %}
                                            {% for slot in time_slots %}
                                                <option value="{{ slot }}" {% if slot == record.time_slot %}selected{% endif %}>{{ slot }}</option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="6:00 AM - 8:00 AM" {% if record.time_slot == "6:00 AM - 8:00 AM" %}selected{% endif %}>6:00 AM - 8:00 AM</option>
                                            <option value="8:00 AM - 10:00 AM" {% if record.time_slot == "8:00 AM - 10:00 AM" %}selected{% endif %}>8:00 AM - 10:00 AM</option>
                                            <option value="10:00 AM - 12:00 PM" {% if record.time_slot == "10:00 AM - 12:00 PM" %}selected{% endif %}>10:00 AM - 12:00 PM</option>
                                            <option value="12:00 PM - 2:00 PM" {% if record.time_slot == "12:00 PM - 2:00 PM" %}selected{% endif %}>12:00 PM - 2:00 PM</option>
                                            <option value="2:00 PM - 4:00 PM" {% if record.time_slot == "2:00 PM - 4:00 PM" %}selected{% endif %}>2:00 PM - 4:00 PM</option>
                                            <option value="4:00 PM - 6:00 PM" {% if record.time_slot == "4:00 PM - 6:00 PM" %}selected{% endif %}>4:00 PM - 6:00 PM</option>
                                            <option value="6:00 PM - 8:00 PM" {% if record.time_slot == "6:00 PM - 8:00 PM" %}selected{% endif %}>6:00 PM - 8:00 PM</option>
                                            <option value="8:00 PM - 10:00 PM" {% if record.time_slot == "8:00 PM - 10:00 PM" %}selected{% endif %}>8:00 PM - 10:00 PM</option>
                                        {% endif %}
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-secondary" onclick="return confirm('Reschedule this booking to the selected slot?');">Reschedule</button>
                                </form>
                            {% else %}
                                <span class="text-gray-400 text-sm">â€”</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-8 text-center">
            <i class="fas fa-calendar-check text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No attendance records</h3>
            <p class="text-gray-500 mb-4">Book your first training session to get started</p>
            <a href="{{ url_for('member.schedule_session') }}" class="btn btn-primary">
                <i class="fas fa-calendar-plus mr-2"></i>Book Session
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
